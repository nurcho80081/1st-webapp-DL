import os

data_dir = 'C:\\Users\\nurcholis\\Documents\\Project Chols\\CNN\\bee_vs_chicken'

os.listdir(data_dir)

import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

%matplotlib inline

from matplotlib.image import imread

test_path = data_dir + '\\test\\'
train_path = data_dir + '\\train\\'

test_path

os.listdir(test_path)

os.listdir(train_path)

# Melihat Data Train Passed

os.listdir(train_path + 'bee')

os.listdir(train_path + 'bee')[0]

train_bee_1 = train_path + 'bee\\' + '10007154554_026417cfd0_n.jpg'
train_bee_1

plt.imshow(imread(train_bee_1))

plt.imread(train_bee_1)

imread(train_bee_1).shape

imread(train_bee_1).max()

# Melihat Data Train Not Pass

os.listdir(train_path + 'chicken')

os.listdir(train_path + 'chicken')[0]

train_chicken_1 = train_path + 'chicken\\' + 'chicken (1000).jpeg'
train_chicken_1

plt.imshow(imread(train_chicken_1))

imread(train_chicken_1)

imread(train_chicken_1).shape

imread(train_chicken_1).max()

pwd

len(os.listdir(train_path + 'bee'))

len(os.listdir(train_path + 'chicken'))

dim1 = []
dim2 = []

for image_filename in os.listdir(train_path + 'bee'):
    
    image = imread(train_path + 'bee\\' + image_filename)
    d1,d2,color = image.shape
    dim1.append(d1)
    dim2.append(d2)

#dim1

#dim2

#sns.jointplot(dim1, dim2)

#np.mean(dim1)

#np.mean(dim2)

# Menentukan Image Shape

#image_shape = (32,32,3)

dim3 = []
dim4 = []

for image_filename in os.listdir(train_path + 'chicken'):
    
    image = imread(train_path + 'chicken\\' + image_filename)
    d3,d4,color = image.shape
    dim3.append(d3)
    dim4.append(d4)

#dim3

#dim4

#sns.jointplot(dim3, dim4)

#np.mean(dim3)

#np.mean(dim4)

image_shape = (238,271,3)

# Build Model

from tensorflow.keras.preprocessing.image import ImageDataGenerator

imread(train_bee_1).max()

image_gen = ImageDataGenerator(rotation_range=20,
                              width_shift_range=0.1,
                              height_shift_range=0.1,
                              shear_range=0.1,
                              zoom_range=0.1,
                              horizontal_flip=True,
                              fill_mode='nearest',
                               rescale=1/255)

plt.imshow(imread(train_bee_1))

plt.imshow(image_gen.random_transform(imread(train_bee_1)))

# Train Test Spliting

train_path

image_gen.flow_from_directory(train_path)

image_gen.flow_from_directory(test_path)

# Tensorflow

from tensorflow.keras.models import Sequential

from tensorflow.keras.layers import Dense, Conv2D, MaxPool2D, Flatten, Dropout

model = Sequential()

model.add(Conv2D(filters=32, kernel_size=(3,3), input_shape= image_shape, activation= 'relu'))
model.add(MaxPool2D(pool_size=(2,2)))

model.add(Conv2D(filters=64, kernel_size=(3,3), input_shape= image_shape, activation= 'relu'))
model.add(MaxPool2D(pool_size=(2,2)))

model.add(Conv2D(filters=64, kernel_size=(3,3), input_shape= image_shape, activation= 'relu'))
model.add(MaxPool2D(pool_size=(2,2)))

#model.add(Conv2D(filters=128, kernel_size=(3,3), input_shape= image_shape, activation= 'relu'))
#model.add(MaxPool2D(pool_size=(2,2)))

# Dense Layer
model.add(Flatten())

model.add(Dense(128, activation='relu'))
model.add(Dropout(0.5))

model.add(Dense(1, activation='sigmoid'))

model.compile(loss='binary_crossentropy', optimizer='adam',
             metrics=['accuracy'])
            

model.summary()

from tensorflow.keras.callbacks import EarlyStopping

early_stopping = EarlyStopping(monitor='val_loss', patience=2)

batch_size = 16

train_image_gen = image_gen.flow_from_directory(train_path,
                                           target_size=image_shape[:2],
                                           color_mode='rgb',
                                           batch_size= batch_size,
                                           class_mode= 'binary')

test_image_gen = image_gen.flow_from_directory(test_path,
                                           target_size=image_shape[:2],
                                           color_mode='rgb',
                                           batch_size= batch_size,
                                           class_mode= 'binary',shuffle=False)

train_image_gen.class_indices

result = model.fit_generator(train_image_gen, epochs=10,
                            validation_data=test_image_gen,
                            callbacks=[early_stopping])

import tensorflow as tf
from tensorflow.keras.models import load_model, save_model

tf.keras.models.save_model(model=model, filepath="bee_vs_chicken.hdf5")

model.evaluate_generator(test_image_gen)

model.metrics_names

my_model = tf.keras.models.load_model('bee_vs_chicken.hdf5')

# Evaluate Model

pred = model.predict_generator(test_image_gen)

pred

prediction = pred > 0.5

prediction

from sklearn.metrics import classification_report, confusion_matrix

test_image_gen.classes

print(classification_report(test_image_gen.classes, prediction))

cf_matrix = confusion_matrix(test_image_gen.classes, prediction)
cf_matrix

ax = plt.subplot()
sns.heatmap(cf_matrix/np.sum(cf_matrix), 
            annot=True, 
            fmt='.2%', 
            cmap='Set3',
            ax = ax)

ax.set_xlabel('Predicted labels');ax.set_ylabel('True labels'); 
ax.set_ylim(2.0, -0.1);
ax.set_title('Confusion Matrix'); 
ax.xaxis.set_ticklabels(['bee', 'chicken']); ax.yaxis.set_ticklabels(['bee', 'chicken']);
# Matplotlib nya error

ax = plt.subplot()
sns.heatmap(cf_matrix, 
            annot=True, 
            fmt='d', 
            cmap='Set3',
            ax = ax)

ax.set_xlabel('Predicted labels');ax.set_ylabel('True labels'); 
ax.set_ylim(2.0, -0.1);
ax.set_title('Confusion Matrix'); 
ax.xaxis.set_ticklabels(['bee', 'chicken']); ax.yaxis.set_ticklabels(['bee', 'chicken']);
# Matplotlib nya error

# Test Image

os.listdir(test_path + 'bee')[400]

test_bee_1 = test_path + 'bee\\' + '431112223_6726e2305a_n.jpg'
test_bee_1

from tensorflow.keras.preprocessing import image

my_image = image.load_img(test_bee_1, target_size=image_shape)

my_image

my_image_arr = image.img_to_array(my_image)

my_image_arr.shape

my_image_arr = np.expand_dims(my_image_arr, axis=0)

my_image_arr.shape

model.predict(my_image_arr)

train_image_gen.class_indices

# Predict Chicken

os.listdir(test_path + 'chicken')[130]

test_chicken_1 = test_path + 'chicken\\' + 'chicken (216).jpeg'
test_chicken_1

my_image2 = image.load_img(test_chicken_1, target_size=image_shape)

my_image2

my_image2_arr = image.img_to_array(my_image2)

my_image2_arr.shape

my_image2_arr = np.expand_dims(my_image2_arr, axis=0)

my_image2_arr.shape

model.predict(my_image2_arr)

# Mencari nilai range prediksi ayam

test_chicken = data_dir + '\\uji_chicken\\'

test_chicken_gen = image_gen.flow_from_directory(test_chicken,
                                           target_size=image_shape[:2],
                                           color_mode='rgb',
                                           batch_size= 16,
                                           class_mode= 'binary',shuffle=False)

pred_chicken = model.predict_generator(test_chicken_gen)

pred_chicken

pred_chicken = pd.DataFrame(pred_chicken)
pred_chicken

df.mean()

df.min()

df.max()

df.describe()

test_chicken = pd.DataFrame(os.listdir(test_path + 'chicken'))

test_chicken

result_chicken = pd.concat([test_chicken, pred_chicken], axis=1)

result_chicken.set_axis(['image', 'value'], axis='columns', inplace=True)

result_chicken['jenis'] = 'ayam'

result_chicken

# Manentukan batas lebah dan ayam

test_bee_df = pd.DataFrame(os.listdir(test_path + 'bee'))

test_bee_df

test_bee = data_dir + '\\uji_bee\\'

test_bee_gen = image_gen.flow_from_directory(test_bee,
                                           target_size=image_shape[:2],
                                           color_mode='rgb',
                                           batch_size= 16,
                                           class_mode= 'binary',shuffle=False)

pred_bee = model.predict_generator(test_bee_gen)

len(pred_bee)

pred_bee = pd.DataFrame(pred_bee)
pred_bee

result_bee = pd.concat([test_bee_df, pred_bee], axis=1)

result_bee

result_bee.set_axis(['image', 'value'], axis='columns', inplace=True)

result_bee

result_bee['jenis'] = 'lebah'

result_bee

result_chicken

test = pd.concat([result_bee,result_chicken])

test['no'] = pd.DataFrame(test.index)

test.reset_index

test

index = test.index

df = pd.DataFrame(test, index=index)

df

plt.figure(figsize=(14,8))
sns.scatterplot(data=test, x='no',y='value', hue='jenis')

plt.figure(figsize=(18,10))
sns.lineplot(data=test, x='no',y='value', hue='jenis')

